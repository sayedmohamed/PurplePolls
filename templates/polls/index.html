{% extends "base.html" %}

{% block content %}

<div class="inner_container">
    <div class="message"></div>
    <strong>Create a new poll</strong>
    <form method="post">
    {% csrf_token %}
        <div>Question:</div><input type="text" name="question" />
        <div>Poll Choice:</div><input type="text" name="choice"><button id="add_choice">Add Choice</button>
        <ul id="choices_list"></ul>
        <input type="submit" value="Create new poll" id="new" />
    </form>
</div>

{% include "polls/poll_list.html" %}


<script type="text/javascript">
    $(document).ready(function() {
        // Register the click actions
        $('#new').click(create_poll);
        $('#add_choice').click(add_choice);

        // Disable form submission until something changes
        $('input[type="text"]').keyup(function() {
            if($(this).val() != '') {
                $('input[type="submit"]').removeAttr('disabled');
            }
        });
    });

    // TODO: Eliminate the use of global variable
    choices = [];

    // Async HTTP request to create a new poll on the server
    create_poll = function (e) {
        e.preventDefault()
        $('input[type="submit"]').attr('disabled','disabled');

        // Make sure to add the new choice in case the user didn't click add
        if ($("form input[name='choice']:text").val().trim().length > 0) {
            add_choice(e);
        }

        var question = $("form input[name='question']:text").val();
        if (question != "") {
            var data = { question: question, choices: choices.toString() };
            var args = { type: "POST", url: "/polls/new", data: data, complete: new_poll_complete };
            $.ajax(args);
        }
    };

    add_choice = function(e) {
        e.preventDefault();
        var new_choice = $("form input[name='choice']:text").val();
        $("form input[name='choice']:text").val('');
        $("#choices_list").append("<li>" + new_choice + "</li>");
        choices.push(new_choice);
    };

    // Callback from the Ajax query - display results / error msg
    var new_poll_complete = function(res, status) {
        if (status === "success") {
            $(".poll_list_outer").html(res.responseText)
            $("#new").disabled=true;
            cleanup();
        }
        else {
            $(".message").html(res.responseText)
        }
    }

    cleanup = function() {
        $("#choices_list").text('');
        $("form input[name='choice']:text").val('');
        $("form input[name='question']:text").val('');
    }

    // Used in order to keep django's CSRF protection
    $.ajaxSetup( {
            data: { csrfmiddlewaretoken: '{{csrf_token}}' }
        });

    </script>

{% endblock %}